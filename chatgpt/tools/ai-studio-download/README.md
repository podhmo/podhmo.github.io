# Google AI Studio 対話履歴ダウンローダー (Deno)

このDenoスクリプトは、Google Drive API を使用して、あなたの "Google AI Studio" フォルダに保存されている対話履歴をインタラクティブに選択し、ダウンロードするためのコマンドラインツールです。

実行すると、フォルダ内の対話履歴が更新日時とファイル名で一覧表示され、カーソルキーでダウンロードしたいファイルを選択できます。ダウンロードされるファイルは、シェルで扱いやすいようにファイル名が調整され（例: `会話履歴 1` -> `会話履歴-1.json`）、`.json` 拡張子が付与されます。

## 機能

-   "Google AI Studio" フォルダ内の対話履歴を更新日時の降順で一覧表示します。
-   表示された一覧から、カーソルキーを使ってダウンロードしたいファイルを選択できます。
-   選択された対話履歴をダウンロードします。
-   ダウンロード時のファイル名は、空白がハイフンに置換されるなど、シェルフレンドリーな形式に変換され、`.json` 拡張子が付きます。

## セットアップ

### 1. Denoのインストール

Denoがまだインストールされていない場合は、公式サイトの指示に従ってインストールしてください:
[https://deno.com/manual/getting_started/installation](https://deno.com/manual/getting_started/installation)

### 2. サービスアカウントキーの準備

このスクリプトはGoogle Drive APIにアクセスするためにサービスアカウントを使用します。

1.  **Google Cloud Consoleでプロジェクトを選択または作成します。**
2.  **Google Drive APIを有効にします。**
    -   ナビゲーションメニューから「APIとサービス」 > 「ライブラリ」を選択します。
    -   「Google Drive API」を検索し、有効にします。
3.  **サービスアカウントを作成します。**
    -   ナビゲーションメニューから「IAMと管理」 > 「サービスアカウント」を選択します。
    -   「サービスアカウントを作成」をクリックし、必要な情報を入力します（例: 名前 `ai-studio-downloader`）。
    -   ロールは不要です（Driveの共有設定でアクセス権を付与するため）。
    -   「完了」をクリックします。
4.  **サービスアカウントキーを作成してダウンロードします。**
    -   作成したサービスアカウントのメールアドレスをメモしておきます。
    -   サービスアカウント一覧で、作成したアカウントのアクション列（︙）から「キーを管理」を選択します。
    -   「鍵を追加」 > 「新しい鍵を作成」を選択します。
    -   キーのタイプとして「JSON」を選択し、「作成」をクリックします。キーファイル（`.json`形式）が自動的にダウンロードされます。
    -   ダウンロードしたキーファイルを安全な場所に保存し、名前を例えば `service-account-key.json` としておきます。**このファイルはGitなどのバージョン管理システムにコミットしないでください。**
5.  **環境変数の設定 または コマンドライン引数での指定**
    ダウンロードしたサービスアカウントキーファイルへのパスを、環境変数 `GOOGLE_APPLICATION_CREDENTIALS` に設定します。
    例 (Linux/macOS):
    ```bash
    export GOOGLE_APPLICATION_CREDENTIALS="/path/to/your/service-account-key.json"
    ```
    または、スクリプト実行時に `--keyFile` オプションで指定することも可能です。

### 3. Google Drive フォルダの共有設定

**非常に重要:** 作成したサービスアカウントがあなたの "Google AI Studio" フォルダにアクセスできるように、そのフォルダをサービスアカウントのメールアドレスと共有する必要があります。

1.  Google Drive ([https://drive.google.com/](https://drive.google.com/)) を開きます。
2.  "Google AI Studio" フォルダを見つけます。（通常、マイドライブ直下にあります）
3.  フォルダを右クリックし、「共有」を選択します。
4.  「ユーザーやグループと共有」の入力欄に、ステップ2-4でメモしたサービスアカウントのメールアドレス（例: `ai-studio-downloader@your-project-id.iam.gserviceaccount.com`）を入力します。
5.  権限として「閲覧者」で十分です。
6.  「送信」（または「保存」）をクリックします。

## インストール (コマンドとして登録)

以下のコマンドを実行して、スクリプトを `ai-studio-download` という名前の実行可能なコマンドとしてインストールできます。

```bash
deno install --allow-net --allow-read --allow-write --allow-env --allow-sys \
  -n ai-studio-download \
  https://<このスクリプトのURL、またはローカルファイルのパス>/ai-studio-download.ts
```

-   `--allow-net`: Google Drive APIへのネットワークアクセスを許可します。
-   `--allow-read`: サービスアカウントキーファイルの読み取り、カレントディレクトリの読み取り（相対パス解決のため）を許可します。
-   `--allow-write`: ダウンロードしたファイルの書き出しを許可します。
-   `--allow-env`: 環境変数 `GOOGLE_APPLICATION_CREDENTIALS` の読み取り、その他CLIの動作に必要な環境変数の読み取りを許可します。
-   `--allow-sys`: `cliffy/prompt` がターミナルの情報を取得するために必要となる場合があります (例: `Deno.osRelease()` など)。
-   `-n ai-studio-download`: コマンド名を指定します。
-   最後の引数には、この `ai-studio-download.ts` ファイルをホストしているURL、またはローカルに保存したファイルへのパスを指定してください。

インストール後、パスが通っていればターミナルから直接 `ai-studio-download` コマンドを実行できるようになります。

## 使用方法

### ヘルプの表示

```bash
ai-studio-download --help
```

### 対話履歴の選択とダウンロード

スクリプトを実行すると、"Google AI Studio" フォルダ内の対話履歴が更新日時順に一覧表示されます。

```bash
ai-studio-download
```

オプションで出力先ディレクトリやキーファイルを指定できます:
```bash
ai-studio-download --output ./my_chat_histories
ai-studio-download --keyFile ./path/to/your-key.json
```

実行すると、以下のようなプロンプトが表示されます:

```
? ダウンロードする対話履歴を選択してください (↑↓キーで選択, Enterで決定):
❯ 2023/10/27 10:30 - 新しいチャット
  2023/10/26 15:00 - ADHD ASD 違い
  2023/10/25 09:00 - プロンプトエンジニアリングについて
  ...
```

カーソルキー (↑↓) でダウンロードしたいファイルを選択し、Enterキーを押すとダウンロードが開始されます。
`Ctrl+C` でいつでも選択をキャンセルできます。

    ダウンロードされるファイルは、例えば元のファイル名が `ADHD ASD 違い` であれば、カレントディレクトリ（または `--output` で指定したディレクトリ）に `ADHD-ASD-違い.json` のような名前で保存されます。